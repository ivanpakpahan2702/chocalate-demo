{% include "separate/header.html" %}
<!-- Typing Modal -->
<div
  class="modal fade"
  id="typingNotifModal"
  tabindex="-1"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-sm modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        Typing Status
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="notif-modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Modal -->

<!-- Users Modal -->
<div
  class="modal fade"
  id="userNotifModal"
  tabindex="-1"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-sm modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        User List
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="user-modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Modal -->
<section class="chatbox">
  <header class="chatbox-header">
    <div class="chatbox-header-title">
      <i class="fas fa-comment-alt"></i>
      <strong>Cochalate v.1.1</strong><br />
    </div>
    <div class="chatbox-header-options d-flex">
      <a
        href="#typingNotifModal"
        data-bs-toggle="modal"
        data-bs-target="#typingNotifModal"
      >
        <div id="typing-notif">
          <i class="fa-solid fa-user-large fa-lg mt-3 me-2 icon-user"></i>
          <div class="typing-indicator"></div>
        </div>
      </a>
      <div class="dropdown">
        <a href="#" id="dropdownMenuLink" data-bs-toggle="dropdown">
          <i class="fas fa-gear fa-lg ms-2" style="color: gray"></i>
        </a>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink">
          <li class="dropdown-item">room : {{code_room}}</li>
          <li class="dropdown-item">my username : {{session['username']}}</li>
          <li>
            <a
              class="dropdown-item"
              href="#userNotifModal"
              data-bs-toggle="modal"
              data-bs-target="#userNotifModal"
              >Users List</a
            >
          </li>
          <li>
            <a class="dropdown-item" href="/logout"
              ><i class="fas fa-right-from-bracket"></i>&nbsp;Log Out</a
            >
          </li>
        </ul>
      </div>
    </div>
  </header>

  <main class="chatbox-chat" id="chatbox-chat">
    {%if messages%} {%for msg in messages%}
    <div
      class="msg {{'left-msg' if (msg['username'] != session['username']) else 'right-msg'}} {{'server' if msg['username']=='Chocalate Server'}}"
    >
      <div class="msg-bubble">
        <div class="msg-info">
          <div class="msg-info-name">{{msg['username']}}</div>
          <div class="msg-info-time">{{msg['time']}}</div>
        </div>
        <div class="msg-text">{{msg['msg']}}</div>
      </div>
    </div>
    {%endfor%} {%endif%}
    <div id="bottom"></div>
  </main>

  <div class="chatbox-inputarea">
    <textarea
      type="text"
      class="chatbox-input"
      placeholder="Enter your message..."
      id="message"
    ></textarea>
    <button type="button" class="chatbox-send-btn" onclick="SendMessage()">
      <i class="fa-solid fa-paper-plane"></i>
    </button>
  </div>
</section>

<script type="text/javascript" charset="utf-8">
  var socket = io();

  //==========================================================================================
  //===================== HANDLING DISCONNECT MESSAGE ========================================
  //==========================================================================================
  //==================================START===================================================
  window.onbeforeunload = function () {
    var currentdate = new Date();
    var datetime =
      currentdate.getDate() +
      "/" +
      (currentdate.getMonth() + 1) +
      "/" +
      currentdate.getFullYear() +
      "-" +
      currentdate.getHours() +
      ":" +
      currentdate.getMinutes() +
      ":" +
      currentdate.getSeconds();
    socket.emit("client_disconnecting", {
      username: "Chocalate Server",
      msg: "{{session['username']}}" + " had left the room",
      time: datetime,
    });
  };
  //==================================END=====================================================
  //==========================================================================================
  //===================== HANDLING DISCONNECT MESSAGE ========================================
  //==========================================================================================

  //==========================================================================================
  //===================== HANDLING RECEIVED MESSAGE ==========================================
  //==========================================================================================
  //==================================START===================================================
  socket.on("message", function (data) {
    if (data.username == '{{session["username"]}}') {
      content =
        '<div class="msg right-msg"> <div class="msg-bubble"><div class="msg-info"><div class="msg-info-name">' +
        data.username +
        '</div><div class="msg-info-time">' +
        data.time +
        '</div></div><div class="msg-text">' +
        data.msg +
        "</div></div></div>";
    } else if (data.username != '{{session["username"]}}') {
      if (data.username === "Chocalate Server") {
        content =
          '<div class="msg left-msg server"> <div class="msg-bubble"><div class="msg-info"><div class="msg-info-name">' +
          data.username +
          '</div><div class="msg-info-time">' +
          data.time +
          '</div></div><div class="msg-text">' +
          data.msg +
          "</div></div></div>";
      } else {
        content =
          '<div class="msg left-msg"> <div class="msg-bubble"><div class="msg-info"><div class="msg-info-name">' +
          data.username +
          '</div><div class="msg-info-time">' +
          data.time +
          '</div></div><div class="msg-text">' +
          data.msg +
          "</div></div></div>";
      }
    }

    if (data.msg !== "") {
      $("#chatbox-chat").append(content);
    }

    if (Array.isArray(data.users_username)) {
      let txt = "";
      data.users_username.forEach(accessing_array);

      let string_length = txt.length;
      let result = txt.substr(0, string_length - 5);

      $(".user-modal-body").html(result);

      function accessing_array(value) {
        txt +=
          '<div class="ms-1 mb-1 border d-flex"><i class="m-1 fa-solid fa-user"></i><p>' +
          value +
          "</p></div><br/>";
      }
    } else {
      $(".user-modal-body").html(
        '<div class="ms-1 mb-1 border"><i class="m-1 fa-solid fa-user"></i><p>' +
          data.users_username +
          "</p></div><br/>"
      );
    }
    $(".msg").last()[0].scrollIntoView();

    indicator =
      '<div class="indicator ms-2 blink-soft" id="' +
      data.username +
      '"><small>&nbsp;' +
      data.username +
      " is typing.</small></div>";

    span_typing =
      "<div id='dash-indicator'><span></span><span></span><span></span></div>";

    if (data.status == "now typing") {
      $(".notif-modal-body").append(indicator);
      $(".typing-indicator").append(span_typing);
      $("#typing-notif").css("display", "inline-block");
    } else if (data.status == "done typing") {
      $("#" + data.username).remove();
      $("#dash-indicator").remove();
      //$("#typing-notif").css("display", "none"); #}
      // $("#typingNotifModal").modal("hide");
    }
  });
  //==================================END=====================================================
  //==========================================================================================
  //===================== HANDLING RECEIVED MESSAGE ==========================================
  //==========================================================================================

  //==========================================================================================
  //===================== FUNCTION TO SEND MESSAGE ===========================================
  //==========================================================================================
  //================================START=====================================================
  function SendMessage() {
    var currentdate = new Date();
    var datetime =
      currentdate.getDate() +
      "/" +
      (currentdate.getMonth() + 1) +
      "/" +
      currentdate.getFullYear() +
      "-" +
      currentdate.getHours() +
      ":" +
      currentdate.getMinutes() +
      ":" +
      currentdate.getSeconds();
    if ($("#message").val() != "") {
      socket.send({
        username: '{{session["username"]}}',
        msg: $("#message").val(),
        time: datetime,
      });
      $("#message").val("");
    }
  }
  //================================END=======================================================
  //==========================================================================================
  //===================== FUNCTION TO SEND MESSAGE ===========================================
  //==========================================================================================

  //==========================================================================================
  //===================== TYPING INDICATOR====================================================
  //==========================================================================================
  //================================START=======================================================
  $(function () {
    var theText = $("#message");
    var typing = false;
    var timeout = undefined;
    var elementClicked = false;

    function timeoutFunction() {
      typing = false;
      socket.emit("client_done_typing", {});
      console.log("done...");
    }

    theText.keydown(function (event) {
      $("#button").click(function () {
        elementClicked = true;
      });

      if (elementClicked != true) {
        if (typing == false) {
          typing = true;
          socket.emit("client_now_typing", {});
          console.log("typing...");
          timeout = setTimeout(timeoutFunction, 1000);
        } else {
          clearTimeout(timeout);
          timeout = setTimeout(timeoutFunction, 1000);
        }
      } else {
        typing = false;
        socket.emit("client_done_typing", {});
        console.log("done...");
      }
    });
  });

  //================================END=======================================================
  //==========================================================================================
  //===================== TYPING INDICATOR ===================================================
  //==========================================================================================

  //==========================================================================================
  //===================== TAB AT TEXT AREA ===================================================
  //================================START=====================================================
  //==========================================================================================

  document.getElementById("message").addEventListener("keydown", function (e) {
    if (e.key == "Tab") {
      e.preventDefault();
      var start = this.selectionStart;
      var end = this.selectionEnd;

      // set textarea value to: text before caret + tab + text after caret
      this.value =
        this.value.substring(0, start) + "\t" + this.value.substring(end);

      // put caret at right position again
      this.selectionStart = this.selectionEnd = start + 1;
    }
  });
  //================================END=======================================================
  //==========================================================================================
  //===================== TAB AT TEXT AREA ===================================================
  //==========================================================================================
</script>
{% include "separate/footer.html" %}
